<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial‑scale=1.0">
  <title>My Progress – Dharana</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="background"></div>
  <div class="todo-container">
    <h1 class="title">My Progress</h1>
    <canvas id="taskChart" width="400" height="200"></canvas>
    <canvas id="timeChart" width="400" height="200"></canvas>
    <p class="streak" id="streakText">Streak: 0 days</p>

    <div class="nav-links">
      <a href="dashboard.html">Home</a>
      <a href="tasks.html">Tasks</a>
      <a href="schedule.html">Schedule</a>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = { /* same config */ };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let user;
    onAuthStateChanged(auth, u => {
      if (!u) return location.href="landing.html";
      user = u; loadStats();
    });

    function loadStats(){
      onValue(ref(db, `tasks/${user.uid}`), snap => {
        const byDate={}, timeByDate={};
        snap.forEach(c => {
          const t = c.val();
          if(t.completed){
            const d = new Date(t.timestamp).toLocaleDateString();
            byDate[d] = (byDate[d]||0)+1;
            timeByDate[d] = (timeByDate[d]||0)+(t.timeRequired||0);
          }
        });

        const dates = Object.keys(byDate).sort((a,b)=> new Date(a)-new Date(b));
        new Chart(document.getElementById('taskChart'), {
          type:'bar',
          data:{ labels:dates, datasets:[{ label:'Tasks Done', data:dates.map(d=>byDate[d]), backgroundColor:'rgba(75,192,192,0.5)' }] }
        });
        new Chart(document.getElementById('timeChart'), {
          type:'line',
          data:{ labels:dates, datasets:[{ label:'Time Spent', data:dates.map(d=>timeByDate[d]), backgroundColor:'rgba(153,102,255,0.5)', borderColor:'#9900ff', fill:true }] }
        });
        // streak logic...
        const uniq = dates.map(d=>new Date(d).toDateString()), sorted = [...new Set(uniq)].sort((a,b)=>new Date(a)-new Date(b));
        let streak=0;
        for(let i=sorted.length-1; i>=0; i--){
          const day = new Date(); day.setDate(day.getDate()-streak);
          if(sorted[i]===day.toDateString()) streak++; else break;
        }
        document.getElementById('streakText').innerText = `Streak: ${streak} day(s)`;
      });
    }
  </script>
</body>
</html>
