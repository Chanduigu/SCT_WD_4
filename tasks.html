<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FocusFlow - Stats</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="background"></div>

  <div class="todo-container">
    <h1 class="title">Productivity Stats</h1>

    <canvas id="priorityChart" style="margin-bottom: 30px;"></canvas>
    <canvas id="dailyChart"></canvas>

    <div class="nav-links">
      <a href="index.html">Dashboard</a>
      <a href="tasks.html">View Tasks</a>
    </div>
  </div>

  <script type="module">
    // Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDfuOrLVQBsatKDAk1jru5Ok0rH42RsHqI",
      authDomain: "to-do-c2c21.firebaseapp.com",
      databaseURL: "https://to-do-c2c21-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "to-do-c2c21",
      storageBucket: "to-do-c2c21.firebaseapp.com",
      messagingSenderId: "948561635865",
      appId: "1:948561635865:web:d563fda0f4c297212d5888"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const priorityCounts = { High: 0, Medium: 0, Low: 0 };
    const dailyCounts = {};

    let currentUser = null;

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "login.html";
      } else {
        currentUser = user;
        loadStats();
      }
    });

    function loadStats() {
      const userRef = ref(db, "tasks/" + currentUser.uid);
      onValue(userRef, (snapshot) => {
        priorityCounts.High = 0;
        priorityCounts.Medium = 0;
        priorityCounts.Low = 0;
        dailyCounts = {};

        const today = new Date();
        const days = [];

        for (let i = 6; i >= 0; i--) {
          const d = new Date();
          d.setDate(today.getDate() - i);
          const key = d.toISOString().split("T")[0];
          dailyCounts[key] = 0;
          days.push(key);
        }

        snapshot.forEach((child) => {
          const task = child.val();
          priorityCounts[task.priority]++;

          const date = new Date(task.timestamp).toISOString().split("T")[0];
          if (dailyCounts[date] !== undefined) {
            dailyCounts[date]++;
          }
        });

        renderCharts(days);
      });
    }

    function renderCharts(days) {
      // Priority Pie Chart
      new Chart(document.getElementById("priorityChart"), {
        type: "pie",
        data: {
          labels: ["High", "Medium", "Low"],
          datasets: [{
            data: [
              priorityCounts.High,
              priorityCounts.Medium,
              priorityCounts.Low
            ],
            backgroundColor: ["#ff4d4d", "#ffaa00", "#3dc0ff"],
            borderWidth: 1
          }]
        },
        options: {
          plugins: {
            title: {
              display: true,
              text: "Task Priority Distribution",
              color: "#fff",
              padding: 20,
              font: { size: 18 }
            },
            legend: { labels: { color: "#fff" } }
          }
        }
      });

      // Daily Task Bar Chart
      new Chart(document.getElementById("dailyChart"), {
        type: "bar",
        data: {
          labels: days,
          datasets: [{
            label: "Tasks",
            data: days.map(d => dailyCounts[d] || 0),
            backgroundColor: "#00c9ff"
          }]
        },
        options: {
          scales: {
            x: { ticks: { color: "#fff" } },
            y: { ticks: { color: "#fff" } }
          },
          plugins: {
            title: {
              display: true,
              text: "Tasks Added (Last 7 Days)",
              color: "#fff",
              padding: 20,
              font: { size: 18 }
            },
            legend: { labels: { color: "#fff" } }
          }
        }
      });
    }
  </script>
</body>
</html>
